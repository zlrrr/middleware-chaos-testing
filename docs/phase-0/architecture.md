# 系统架构设计

## 1. 系统概述

中间件混沌测试框架（Middleware Chaos Testing, MCT）是一个可扩展的稳定性测试工具，通过模拟用户操作检测并量化中间件服务在混沌场景下的稳定性指标。

### 1.1 设计目标

- **可扩展性**: 支持多种中间件类型（Redis、Kafka等）
- **准确性**: 准确收集和计算稳定性指标
- **可靠性**: 测试过程本身稳定可靠
- **易用性**: 简单的命令行界面和清晰的报告
- **智能化**: 自动评分和生成改进建议

## 2. 系统架构

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      CLI Layer (用户界面层)                    │
│  - 命令行参数解析                                              │
│  - 配置文件加载                                                │
│  - 报告输出                                                   │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                  Orchestrator Layer (编排层)                 │
│  - 测试流程编排                                               │
│  - 并发控制                                                  │
│  - 时间管理                                                  │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                    Core Logic Layer (核心逻辑层)              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Metrics    │  │   Detector   │  │  Evaluator   │      │
│  │   Collector  │  │   (异常检测)  │  │  (稳定性评估) │      │
│  │   (指标收集)  │  │              │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                 Middleware Adapter Layer (适配器层)          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │    Redis     │  │    Kafka     │  │   Future...  │      │
│  │   Adapter    │  │   Adapter    │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                    Target Middleware (目标中间件)             │
│             Redis / Kafka / RabbitMQ / ...                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 CLI层
- **命令解析器**: 解析用户命令行参数
- **配置管理器**: 加载和验证配置文件
- **报告生成器**: 生成多种格式的报告（Console/JSON/Markdown）

#### 2.2.2 Orchestrator层
- **测试编排器**: 管理测试生命周期
- **工作负载生成器**: 生成测试操作负载
- **时间控制器**: 控制测试持续时间

#### 2.2.3 Core Logic层
- **指标收集器**: 实时收集性能和可靠性指标
- **异常检测器**: 检测异常行为和故障
- **稳定性评估器**: 评分和生成建议

#### 2.2.4 Adapter层
- **中间件客户端**: 实现统一的中间件操作接口
- **连接管理**: 管理连接池和重连逻辑
- **操作执行**: 执行具体的中间件操作

## 3. 核心流程

### 3.1 测试执行流程

```
开始测试
   ↓
加载配置
   ↓
初始化中间件客户端
   ↓
连接测试
   ↓
开始指标收集 ←──────┐
   ↓                 │
执行测试操作          │
   ↓                 │
记录结果             │
   ↓                 │
异常检测             │
   ↓                 │
是否达到时长? ─No→───┘
   ↓ Yes
计算最终指标
   ↓
稳定性评估
   ↓
生成报告
   ↓
输出结果
   ↓
清理资源
   ↓
结束测试
```

### 3.2 指标收集流程

```
操作开始
   ↓
记录开始时间
   ↓
执行操作
   ↓
记录结束时间
   ↓
记录操作结果
   ↓
┌────────────────┐
│ 更新实时指标:   │
│ - 总操作数      │
│ - 成功/失败数   │
│ - 延迟分布      │
│ - 错误类型      │
└────────────────┘
   ↓
异步刷新到存储
```

### 3.3 评分流程

```
收集到的指标
   ↓
计算可用性得分 (30%)
   ↓
计算性能得分 (25%)
   ↓
计算可靠性得分 (25%)
   ↓
计算恢复力得分 (20%)
   ↓
加权求和 → 总分
   ↓
确定等级 (EXCELLENT/GOOD/FAIR/POOR/FAILED)
   ↓
确定状态 (PASS/WARNING/FAIL)
   ↓
识别问题
   ↓
生成改进建议
   ↓
生成判断依据
   ↓
返回评估结果
```

## 4. 数据流

### 4.1 数据收集流

```
中间件操作
   ↓
操作结果 (Result)
   ↓
指标收集器 (MetricsCollector)
   ↓
原始指标 (RawMetrics)
   ↓
指标计算器 (MetricsCalculator)
   ↓
聚合指标 (StabilityMetrics)
   ↓
评估器 (Evaluator)
   ↓
评估结果 (EvaluationResult)
   ↓
报告生成器 (Reporter)
   ↓
输出报告
```

## 5. 部署架构

### 5.1 单机部署

```
┌─────────────────────────────────────────┐
│         Docker Host                      │
│                                          │
│  ┌────────────────┐                     │
│  │  MCT Container │                     │
│  │                │                     │
│  │  ┌──────────┐  │                     │
│  │  │   MCT    │  │                     │
│  │  │   CLI    │  │                     │
│  │  └────┬─────┘  │                     │
│  └───────┼────────┘                     │
│          │                               │
│  ┌───────▼────────┐  ┌────────────────┐ │
│  │ Redis Container│  │ Kafka Container│ │
│  │                │  │                │ │
│  │  ┌──────────┐  │  │  ┌──────────┐  │ │
│  │  │  Redis   │  │  │  │  Kafka   │  │ │
│  │  │  Server  │  │  │  │  Broker  │  │ │
│  │  └──────────┘  │  │  └──────────┘  │ │
│  └────────────────┘  └────────────────┘ │
│                                          │
└─────────────────────────────────────────┘
```

### 5.2 生产环境部署

```
┌─────────────────────────────────────────────────────────────┐
│                      Kubernetes Cluster                      │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    MCT Namespace                        │ │
│  │                                                          │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │ MCT Pod  │  │ MCT Pod  │  │ MCT Pod  │             │ │
│  │  │          │  │          │  │          │             │ │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘             │ │
│  │       │             │             │                     │ │
│  │       └─────────────┼─────────────┘                     │ │
│  │                     │                                   │ │
│  │              ┌──────▼───────┐                          │ │
│  │              │   Service    │                          │ │
│  │              └──────┬───────┘                          │ │
│  └─────────────────────┼──────────────────────────────────┘ │
│                        │                                     │
│  ┌─────────────────────▼──────────────────────────────────┐ │
│  │                Target Middleware Cluster                │ │
│  │                                                          │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │  Redis   │  │  Redis   │  │  Redis   │             │ │
│  │  │  Master  │  │  Slave   │  │  Slave   │             │ │
│  │  └──────────┘  └──────────┘  └──────────┘             │ │
│  │                                                          │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │  Kafka   │  │  Kafka   │  │  Kafka   │             │ │
│  │  │  Broker1 │  │  Broker2 │  │  Broker3 │             │ │
│  │  └──────────┘  └──────────┘  └──────────┘             │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 6. 技术选型

### 6.1 编程语言
- **Go 1.21+**: 主要实现语言，高性能、并发友好

### 6.2 核心依赖
- **github.com/redis/go-redis**: Redis客户端
- **github.com/IBM/sarama**: Kafka客户端
- **github.com/spf13/cobra**: CLI框架
- **github.com/spf13/viper**: 配置管理
- **github.com/stretchr/testify**: 测试框架
- **gopkg.in/yaml.v3**: YAML配置解析

### 6.3 可选依赖
- **github.com/prometheus/client_golang**: Prometheus指标导出
- **github.com/gin-gonic/gin**: Web界面（可选）

## 7. 扩展性设计

### 7.1 新增中间件支持

1. 实现 `MiddlewareClient` 接口
2. 实现具体的操作方法
3. 在工厂类中注册新的中间件类型
4. 添加对应的配置模板

### 7.2 新增指标

1. 在 `StabilityMetrics` 结构中添加新字段
2. 在 `MetricsCollector` 中添加收集逻辑
3. 在 `Evaluator` 中添加评分逻辑
4. 更新报告模板

### 7.3 自定义评分规则

1. 实现自定义 `Evaluator` 接口
2. 提供自定义阈值配置
3. 实现自定义建议生成逻辑

## 8. 安全性考虑

### 8.1 认证与授权
- 支持密码认证（Redis）
- 支持SASL认证（Kafka）
- 凭证信息不记录到日志

### 8.2 数据安全
- 测试数据使用唯一前缀，避免污染生产数据
- 测试结束后自动清理测试数据
- 支持只读模式（仅查询操作）

### 8.3 资源限制
- 限制并发连接数
- 限制操作频率
- 超时保护机制

## 9. 可观测性

### 9.1 日志
- 结构化日志输出
- 可配置日志级别（DEBUG/INFO/WARN/ERROR）
- 关键操作审计日志

### 9.2 指标
- 测试过程实时指标
- 资源使用情况（CPU/内存）
- 错误统计

### 9.3 追踪
- 操作级别的追踪
- 性能瓶颈分析

## 10. 容错与恢复

### 10.1 连接故障处理
- 自动重连机制
- 指数退避算法
- 最大重试次数限制

### 10.2 测试中断恢复
- 记录测试进度
- 支持从中断点恢复
- 生成部分测试报告

## 11. 性能优化

### 11.1 并发控制
- 使用goroutine池管理并发
- 避免goroutine泄漏
- 合理设置缓冲区大小

### 11.2 内存优化
- 使用对象池减少GC压力
- 流式处理大数据集
- 及时释放不用的资源

### 11.3 网络优化
- 连接复用
- 批量操作
- 压缩传输（如果支持）

## 12. 未来扩展方向

### 12.1 Phase 2
- Web UI监控界面
- 实时图表展示
- 历史测试对比

### 12.2 Phase 3
- 分布式测试支持
- 更多中间件支持（RabbitMQ、MongoDB等）
- 智能测试场景生成

### 12.3 Phase 4
- CI/CD集成
- 自动化测试调度
- 告警和通知系统
